{
  "name": "real",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "index",
        "options": {}
      },
      "id": "6b092946-3705-47ec-af87-c544ace4e5fb",
      "name": "Webhook: Index Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -176,
        192
      ],
      "webhookId": "doc-index-main"
    },
    {
      "parameters": {
        "functionCode": "  // Chunk Text\nconst MAX_CHARS = 3000; // í•„ìš”í•˜ë©´ 1500~4000 ì‚¬ì´ë¡œ ì¡°ì ˆ\n\nfunction chunkString(str, size) {\n  const chunks = [];\n  let i = 0;\n  while (i < str.length) {\n    chunks.push(str.slice(i, i + size));\n    i += size;\n  }\n  return chunks;\n}\n\nconst result = [];\n\nfor (const item of items) {\n  let text = item.json.text;\n\n  // txt ê°™ì€ ê²½ìš°: binary.data(base64) ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ\n  if (!text && item.binary && item.binary.data) {\n    const buff = Buffer.from(item.binary.data, 'base64');\n    text = buff.toString('utf8');\n  }\n\n  if (!text) {\n    // ì—¬ê¸°ì„œ ë‚˜ë˜ ì—ëŸ¬ ë©”ì‹œì§€\n    throw new Error('Chunk Text: text ë˜ëŠ” binary.data ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n  }\n\n  // ì¤„ë°”ê¿ˆ/ê³µë°± ì‚´ì§ ì •ë¦¬\n  text = text\n    .replace(/\\r\\n/g, '\\n')\n    .replace(/\\u0000/g, '')        // ë„ë¬¸ì ì œê±°\n    .replace(/\\n{3,}/g, '\\n\\n');   // ë„ˆë¬´ ë§ì€ ì¤„ë°”ê¿ˆ ì¶•ì†Œ\n\n  const chunks = chunkString(text, MAX_CHARS);\n  const total = chunks.length;\n\n  chunks.forEach((chunk, index) => {\n    result.push({\n      json: {\n        // ì›ë˜ ë©”íƒ€ë°ì´í„° ìœ ì§€ (document_id, user_id ë“±)\n        ...item.json,\n        // ì²­í¬ ì •ë³´\n        chunk_index: index,\n        chunk_count: total,\n        chunk_id: index,\n        total_chunks: total,\n        content: chunk,\n      },\n    });\n  });\n}\n\nreturn result;\n"
      },
      "id": "8d04f8fc-23c2-4658-9823-2a767fed07ef",
      "name": "Chunk Text",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        848,
        192
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "87233e62-ac07-4c54-a240-dda9bcfb5a9f",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        1280,
        192
      ]
    },
    {
      "parameters": {
        "functionCode": "// Search ë¬¸ì„œ ë¹Œë“œ\n\n// 1) ì‹œì‘ Webhook (fallbackìš©)\nconst trigger = $node['Webhook: Index Trigger'].json;\nconst root = trigger.body ?? trigger;\n\n// 2) í˜„ì¬ ìš”ì²­ì˜ ì²­í¬ ë©”íƒ€ë°ì´í„°ëŠ” Split In Batchesì—ì„œ ê°€ì ¸ì˜¤ê¸°\n//    â†’ ì—¬ê¸°ì—ëŠ” content, document_id, user_id, group_id, blob_path, title ë“± ìˆìŒ\nconst meta = $node['Split In Batches'].json;\n\n// 3) Azure OpenAI Embedding ì‘ë‹µì—ì„œ embedding êº¼ë‚´ê¸°\nconst body = $json.body ?? $json;\nconst emb =\n  body.data?.[0]?.embedding ||\n  $json.embedding ||\n  $json.output;\n\n// 4) í•„ë“œë“¤ ì¡°ë¦½\nconst documentId =\n  meta.document_id ??\n  root.document_id ??\n  root.id;\n\nconst userId =\n  meta.user_id ??\n  root.user_id;\n\nconst groupId =\n  meta.group_id ??\n  root.group_id ??\n  null;\n\n// chunk ì •ë³´ (ì—†ìœ¼ë©´ 0)\nconst chunkId =\n  meta.chunk_id ??\n  meta.chunk_index ??\n  0;\n\n// ğŸ”¥ ì—¬ê¸°ì„œ contentëŠ” Split In Batches(=meta)ì—ì„œ ê°€ì ¸ì˜¨ë‹¤\nconst content = meta.content ?? '';\n\nconst blobPath =\n  meta.blob_path ??\n  root.blob_path;\n\nconst title =\n  meta.title ??\n  root.title ??\n  meta.original_file_name ??\n  root.original_file_name ??\n  documentId;\n\nconst originalFileName =\n  meta.original_file_name ??\n  root.original_file_name ??\n  title;\n\nreturn [\n  {\n    json: {\n      value: [\n        {\n          '@search.action': 'upload',\n          id: `${documentId}_${chunkId}`,  // ë¬¸ì„œID_ì²­í¬ë²ˆí˜¸ (ì˜ˆ: ..._0, ..._1, ...)\n          document_id: documentId,\n          user_id: userId,\n          group_id: groupId,\n          content,                         // â¬… ì´ì œ ì—¬ê¸° ë“¤ì–´ê°!\n          // ì¸ë±ìŠ¤ì— chunk_id í•„ë“œ ì—†ìœ¼ë©´ ì•„ë˜ ì¤„ì€ ë¹¼ë„ ë¨\n          chunk_id: chunkId,\n          source_path: blobPath,\n          title,\n          original_file_name: originalFileName,\n          embedding: emb,\n        },\n      ],\n    },\n  },\n];\n"
      },
      "id": "65accb61-f20e-4194-929a-75d0344d2bda",
      "name": "Build Search Doc",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1760,
        192
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $node[\"Load Azure Env\"].json.AZURE_SEARCH_ENDPOINT }}/indexes/{{ $node[\"Load Azure Env\"].json.AZURE_SEARCH_INDEX_NAME }}/docs/index?api-version=2023-11-01\n",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={{ { value: $json.value } }}",
        "headerParametersJson": "={{ {\n  \"Content-Type\": \"application/json\",\n  \"api-key\": $node[\"Load Azure Env\"].json.AZURE_SEARCH_ADMIN_KEY\n} }}"
      },
      "id": "dcc8e161-1579-44d7-945e-481d648dad39",
      "name": "Azure Search Upsert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2016,
        192
      ]
    },
    {
      "parameters": {
        "functionCode": "// ë°°ì¹˜ ì¢…ë£Œ í›„ ì„±ê³µ ì½œë°± payload\nreturn [{\n  document_id: $json.document_id || $items()[0].json.document_id,\n  status: 'processed',\n  chunk_count: $items()[0].json.total_chunks || 0,\n  error_message: null\n}];"
      },
      "id": "b3fac355-769f-4126-942f-c120a6b2b5d2",
      "name": "Prep Callback Success",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1552,
        448
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $node[\"Load Azure Env\"].json.FASTAPI_CALLBACK_URL }}",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "document_id",
              "value": "={{$(\"Load Azure Env\").item.json.body.id}}"
            },
            {
              "name": "status",
              "value": "={{ $json.status ?? \"processed\" }}"
            },
            {
              "name": "chunk_count",
              "value": "={{ $json.chunk_count ?? $json.total_chunks ?? 0 }}"
            },
            {
              "name": "error_message",
              "value": "={{ $json.error_message ?? null }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-N8N-Token",
              "value": "={{ $node[\"Load Azure Env\"].json.N8N_CALLBACK_TOKEN }}"
            }
          ]
        }
      },
      "id": "2bf250d3-d167-4fe0-912d-534e21f100ba",
      "name": "HTTP Callback Success",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1856,
        720
      ]
    },
    {
      "parameters": {},
      "id": "78b61ff4-1f98-4600-97db-d0085664e278",
      "name": "On Error",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        1040,
        624
      ]
    },
    {
      "parameters": {
        "functionCode": "const e = $json;\nreturn [{\n  document_id: e?.workflow?.lastNodeExecutedData?.document_id || '',\n  status: 'failed',\n  chunk_count: 0,\n  error_message: e?.message || 'indexing failed'\n}];"
      },
      "id": "866b2ee3-eb29-4efd-bbd0-810b6a860299",
      "name": "Prep Callback Failure",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1280,
        624
      ]
    },
    {
      "parameters": {
        "resource": "blob",
        "operation": "get",
        "container": {
          "__rl": true,
          "value": "user-docs",
          "mode": "list",
          "cachedResultName": "user-docs"
        },
        "blob": {
          "__rl": true,
          "value": "={{ $json.body.blob_path }}",
          "mode": "id"
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.azureStorage",
      "typeVersion": 1,
      "position": [
        144,
        192
      ],
      "id": "59f39aef-5413-4ad6-9a30-b01d535f1951",
      "name": "Get blob",
      "credentials": {
        "azureStorageSharedKeyApi": {
          "id": "cFSVV8qoUUdFJ9Ep",
          "name": "Azure Storage account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $node[\"Load Azure Env\"].json.AZURE_OPENAI_ENDPOINT }}/openai/deployments/{{ $node[\"Load Azure Env\"].json.AZURE_OPENAI_EMBED_DEPLOYMENT }}/embeddings?api-version=2024-02-15-preview\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "api-key",
              "value": "={{ $node[\"Load Azure Env\"].json.AZURE_OPENAI_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "input",
              "value": "={{$json.content}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1536,
        192
      ],
      "id": "bd930840-25ba-4b8c-8cda-c1d55342b40a",
      "name": "Azure OpenAI Embedding"
    },
    {
      "parameters": {
        "jsCode": "// ë“¤ì–´ì˜¨ body ìœ ì§€í•˜ë©´ì„œ env ê°’ë§Œ ë§ë¶™ì´ê¸°\nreturn [\n  {\n    ...$json,\n    AZURE_OPENAI_ENDPOINT: $env.AZURE_OPENAI_ENDPOINT,\n    AZURE_OPENAI_EMBED_DEPLOYMENT: $env.AZURE_OPENAI_EMBED_DEPLOYMENT,\n    AZURE_OPENAI_API_KEY: $env.AZURE_OPENAI_API_KEY,\n    AZURE_SEARCH_ENDPOINT: $env.AZURE_SEARCH_ENDPOINT,\n    AZURE_SEARCH_INDEX_NAME: $env.AZURE_SEARCH_INDEX_NAME,\n    AZURE_SEARCH_ADMIN_KEY: $env.AZURE_SEARCH_ADMIN_KEY,\n    FASTAPI_CALLBACK_URL: $env.FASTAPI_CALLBACK_URL,\n    N8N_CALLBACK_TOKEN: $env.N8N_CALLBACK_TOKEN,\n    AZURE_DI_ENDPOINT: $env.AZURE_DI_ENDPOINT,\n    AZURE_DI_API_KEY: $env.AZURE_DI_API_KEY,\n    AZURE_BLOB_BASE_URL: $env.AZURE_BLOB_BASE_URL,\n    AZURE_BLOB_SAS: $env.AZURE_BLOB_SAS,\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        192
      ],
      "id": "517bf83f-f63b-439c-b6cf-66e2571c2cfb",
      "name": "Load Azure Env"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $node[\"Load Azure Env\"].json.FASTAPI_CALLBACK_URL }}",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "document_id",
              "value": "={{ $json.document_id || $items(0).json.document_id || '' }}"
            },
            {
              "name": "status",
              "value": "={{ $json.status || 'failed' }}"
            },
            {
              "name": "error_message",
              "value": "={{ $json.error_message || 'indexing failed' }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-N8N-Token",
              "value": "={{ $node[\"Load Azure Env\"].json.N8N_CALLBACK_TOKEN }}"
            }
          ]
        }
      },
      "id": "9a3a27e1-008e-458f-9a41-c930ee1af339",
      "name": "HTTP Callback Failur2e",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1280,
        832
      ],
      "disabled": true
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $node[\"Load Azure Env\"].json.FASTAPI_CALLBACK_URL }}",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "document_id",
              "value": "={{ $node[\"Webhook: Index Trigger\"].json.body.document_id }}"
            },
            {
              "name": "status",
              "value": "={{ $json.status || 'failed' }}"
            },
            {
              "name": "chunk_count",
              "value": "={{ $json.chunk_count || 0 }}"
            },
            {
              "name": "error_message",
              "value": "={{ $json.error_message || $json.error || $json.message || '' }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "X-N8N-Token",
              "value": "={{ $node[\"Load Azure Env\"].json.N8N_CALLBACK_TOKEN }}"
            }
          ]
        }
      },
      "id": "93a2c3bb-1373-4edf-a84f-92bd9832a928",
      "name": "HTTP Callback Failure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1504,
        624
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì²­í¬ + ì›ë³¸ ë©”íƒ€ë°ì´í„° ë¶™ì´ê¸°\n\nconst trigger = $node['Webhook: Index Trigger'].json;\nconst body = trigger.body ?? trigger;\n\nreturn $items().map(item => {\n  const chunk = item.json;\n\n  const chunkId = chunk.chunk_id ?? chunk.chunk_index ?? 0;\n  const totalChunks = chunk.total_chunks ?? chunk.chunk_count ?? 1;\n\n  return {\n    json: {\n      // ì²­í¬ ì •ë³´ ê·¸ëŒ€ë¡œ/ë³€í™˜í•´ì„œ ìœ ì§€\n      ...chunk,\n      chunk_id: chunkId,\n      total_chunks: totalChunks,\n\n      // Webhookì—ì„œ ë“¤ì–´ì˜¨ ë©”íƒ€ë°ì´í„° ë®ì–´ì“°ê¸°\n      document_id: body.document_id,\n      user_id: body.user_id,\n      group_id: body.group_id,\n      blob_path: body.blob_path,\n      title: body.title,\n      original_file_name: body.original_file_name,\n    },\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        192
      ],
      "id": "c03b66a5-8157-4241-a9f8-ba4946d74644",
      "name": "Attach Metadata"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$node[\"Webhook: Index Trigger\"].json.body?.mime_type || $node[\"Webhook: Index Trigger\"].json.mime_type}}",
                    "rightValue": "text/plain",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "fe6950cc-6fb5-41b9-8ff9-286b06210ac6"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0cc9597d-baf8-4106-91b4-6b2eca151dda",
                    "leftValue": "={{$node[\"Webhook: Index Trigger\"].json.body?.mime_type || $node[\"Webhook: Index Trigger\"].json.mime_type}}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "020f361a-1dcd-4630-b832-2ad9801057fb",
                    "leftValue": "={{$node[\"Webhook: Index Trigger\"].json.body?.mime_type || $node[\"Webhook: Index Trigger\"].json.mime_type}}",
                    "rightValue": "application/vnd.openxmlformats-officedocument.presentationml.presentation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a1a6b7d8-001f-4e08-b0ed-ed807e29d5da",
                    "leftValue": "={{$node[\"Webhook: Index Trigger\"].json.body?.mime_type || $node[\"Webhook: Index Trigger\"].json.mime_type}}",
                    "rightValue": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        480,
        160
      ],
      "id": "8e38c68a-f24e-48f6-a30e-cfcbbcf28b28",
      "name": "Switch"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        432,
        448
      ],
      "id": "e7f10b4c-01e3-4e9f-afa9-470f69d2caf6",
      "name": "Wait for DI",
      "webhookId": "00241af6-6f9b-4423-b65c-1418ca7719fb"
    },
    {
      "parameters": {
        "url": "={{$node[\"Prepare DI Result URL\"].json[\"diResultUrl\"]}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Ocp-Apim-Subscription-Key",
              "value": "={{$node[\"Load Azure Env\"].json.AZURE_DI_API_KEY}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        448,
        624
      ],
      "id": "26d2110c-6017-4f96-a59f-d1a5b06e7a9f",
      "name": "Get DI Result"
    },
    {
      "parameters": {
        "jsCode": "// DI -> Text (ì •ìƒ analyzeResult.content ê¸°ì¤€)\n\nconst output = [];\n\nfor (const item of items) {\n  const src = item.json || {};\n\n  // analyzeResult ìœ„ì¹˜ ì°¾ê¸°\n  const analyze =\n    src.analyzeResult ||\n    src.body?.analyzeResult ||\n    src; // fallback\n\n  const content =\n    (analyze.content && analyze.content.trim()) || \"\";\n\n  if (!content) {\n    throw new Error(\"Document Intelligence ê²°ê³¼ì— contentê°€ ì—†ìŠµë‹ˆë‹¤.\");\n  }\n\n  output.push({\n    json: {\n      ...src,\n      text: content, // â¬… Chunk Text ë…¸ë“œê°€ ì½ëŠ” í•„ë“œ\n    },\n  });\n}\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        448
      ],
      "id": "0722ede1-5996-4d9d-ada6-6b1ae2bd7a08",
      "name": "DI â†’ Text"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item;\n\nconst baseUrl =\n  $node[\"Load Azure Env\"].json.AZURE_BLOB_BASE_URL ||\n  'https://<account>.blob.core.windows.net/<container>'; // fallback\n\nconst sas = $node[\"Load Azure Env\"].json.AZURE_BLOB_SAS || '';\n\nconst blobPath = item.json.name; // Get blob ê²°ê³¼ì˜ name\n\n// ì•ë’¤ ìŠ¬ë˜ì‹œ ì •ë¦¬\nconst url =\n  baseUrl.replace(/\\/+$/, '') + '/' +\n  blobPath.replace(/^\\/+/, '') +\n  (sas ? sas : '');\n\nreturn [\n  {\n    json: {\n      diFileUrl: url,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        192
      ],
      "id": "4f9934a5-4c0d-4e56-b0cb-98a5bc3e2784",
      "name": "Build DI Url"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$node[\"Load Azure Env\"].json.AZURE_DI_ENDPOINT}}/documentintelligence/documentModels/prebuilt-layout:analyze?api-version=2024-11-30",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Ocp-Apim-Subscription-Key",
              "value": "={{$node[\"Load Azure Env\"].json.AZURE_DI_API_KEY}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "urlSource",
              "value": "={{$json.diFileUrl}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -48,
        672
      ],
      "id": "2aaa6504-a782-4766-92cb-e58626778a35",
      "name": "Extract text (Azure DI)",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// ê° itemì—ëŠ” json.diFileUrl ì´ ë“¤ì–´ìˆë‹¤ê³  ê°€ì •\n// Azure Document Intelligence ì„¤ì •ì€ \"Load Azure Env\" ë…¸ë“œì—ì„œ ê°€ì ¸ì˜´\n\nconst endpoint = $node[\"Load Azure Env\"].json.AZURE_DI_ENDPOINT;\nconst apiKey   = $node[\"Load Azure Env\"].json.AZURE_DI_API_KEY;\n\n// prebuilt-layout ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸\nconst url = `${endpoint}/documentintelligence/documentModels/prebuilt-layout:analyze?api-version=2024-11-30`;\n\nconst results = [];\n\nfor (const item of items) {\n  const diFileUrl = item.json.diFileUrl;\n\n  const options = {\n    method: 'POST',\n    uri: url,\n    headers: {\n      'Ocp-Apim-Subscription-Key': apiKey,\n    },\n    body: {\n      urlSource: diFileUrl,\n    },\n    json: true,\n    resolveWithFullResponse: true,   // í—¤ë”ê¹Œì§€ ë°›ê¸° ìœ„í•´\n  };\n\n  const res = await this.helpers.request(options);\n\n  // Prepare DI Result URL ë…¸ë“œê°€ ì“°ê¸° ì¢‹ì€ í˜•íƒœë¡œ ì •ë¦¬\n  results.push({\n    json: {\n      statusCode: res.statusCode,\n      headers:   res.headers,\n      body:      res.body,\n    },\n  });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        448
      ],
      "id": "210a1598-399f-480c-8a6e-dcefc8c89d70",
      "name": "Extract text (Azure DI - Code)"
    },
    {
      "parameters": {
        "jsCode": "const out = [];\n\nfor (const item of items) {\n  // Code ë…¸ë“œì—ì„œ ë„˜ê²¨ì¤€ êµ¬ì¡°: { statusCode, headers, body }\n  let headers = item.json.headers || {};\n\n  // í˜¹ì‹œ ë°°ì—´ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ë°©ì–´ì½”ë“œ\n  if (Array.isArray(headers)) {\n    headers = headers[0] || {};\n  }\n\n  // í—¤ë” í‚¤ëŠ” ë³´í†µ ì†Œë¬¸ìë¡œ ë“¤ì–´ì˜´\n  const opLocation =\n    headers['operation-location'] ||\n    headers['Operation-Location'] ||\n    headers['operation-location'.toLowerCase()];\n\n  if (!opLocation) {\n    throw new Error('Document Intelligence ì‘ë‹µì— operation-location í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.');\n  }\n\n  // ë‹¤ìŒ ë…¸ë“œì—ì„œ polling í•  URLë§Œ ë„˜ê²¨ì£¼ë©´ ë¨\n  out.push({\n    json: {\n      diResultUrl: opLocation,\n      // í•„ìš”í•˜ë©´ ë””ë²„ê·¸ìš©ìœ¼ë¡œ statusCode/bodyë„ ê°™ì´ ë„˜ê²¨ë„ ë¨\n      statusCode: item.json.statusCode,\n    },\n  });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        448
      ],
      "id": "4d5bd1d6-feb7-44af-968b-6ae4bca4a0e7",
      "name": "Prepare DI Result URL"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f0b43444-144f-44ed-9641-a3b7bc0d67f9",
              "leftValue": "={{$json[\"status\"]}}",
              "rightValue": "succeeded",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        592,
        624
      ],
      "id": "cd922128-2107-40ce-be50-bf433f4321ff",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Check DI Status & Retry Count\n\nconst maxTries = 30; // ìµœëŒ€ í´ë§ íšŸìˆ˜ (ì˜ˆ: 30ë²ˆ * 5ì´ˆ = ìµœëŒ€ 150ì´ˆ)\n\nreturn items.map(item => {\n  const j = item.json || {};\n\n  const status =\n    j.status ||\n    j.body?.status;\n\n  // 1) ì‹¤íŒ¨/ì·¨ì†Œ ìƒíƒœë©´ ë°”ë¡œ ì—ëŸ¬\n  if (status === \"failed\" || status === \"cancelled\" || status === \"canceled\") {\n    throw new Error(`Document Intelligence failed. status=${status}`);\n  }\n\n  // 2) ì¬ì‹œë„ íšŸìˆ˜ ê´€ë¦¬\n  const tries = (j._diTries || 0) + 1;\n  if (tries > maxTries) {\n    throw new Error(\n      `Document Intelligence polling exceeded ${maxTries} tries (status=${status})`,\n    );\n  }\n\n  j._diTries = tries;\n  item.json = j;\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        640
      ],
      "id": "31a503d0-3b6d-4d13-b9ef-84508a82a0b1",
      "name": "Check DI Status & Retry"
    },
    {
      "parameters": {
        "resource": "blob",
        "operation": "get",
        "container": {
          "__rl": true,
          "value": "user-docs",
          "mode": "list",
          "cachedResultName": "user-docs"
        },
        "blob": {
          "__rl": true,
          "value": "={{ $node[\"Webhook: Index Trigger\"].json.body.blob_path }}",
          "mode": "id"
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.azureStorage",
      "typeVersion": 1,
      "position": [
        560,
        -32
      ],
      "id": "3caf24ab-9991-4cdb-9c66-47e6054ac4c9",
      "name": "Txt Get blob",
      "credentials": {
        "azureStorageSharedKeyApi": {
          "id": "cFSVV8qoUUdFJ9Ep",
          "name": "Azure Storage account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Txt â†’ Text : Azure Storage get blob ê²°ê³¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ\n\nconst results = [];\n\nfor (const item of items) {\n  let text = item.json.text || '';\n\n  // 1) binary ìª½ì—ì„œ base64 ë¬¸ìì—´ ì°¾ê¸°\n  let base64 = null;\n\n  if (item.binary) {\n    // ê°€ì¥ ì¼ë°˜ì ì¸ êµ¬ì¡°: binary.data.data\n    if (item.binary.data) {\n      if (typeof item.binary.data === 'string') {\n        base64 = item.binary.data;\n      } else if (\n        typeof item.binary.data === 'object' &&\n        typeof item.binary.data.data === 'string'\n      ) {\n        base64 = item.binary.data.data;\n      }\n    }\n\n    // í˜¹ì‹œ í‚¤ ì´ë¦„ì´ dataê°€ ì•„ë‹ ë•Œ ëŒ€ë¹„ (ì²« ë²ˆì§¸ binary í‚¤ ì‚¬ìš©)\n    if (!base64) {\n      const keys = Object.keys(item.binary);\n      if (keys.length > 0) {\n        const bin = item.binary[keys[0]];\n        if (typeof bin === 'string') {\n          base64 = bin;\n        } else if (bin && typeof bin.data === 'string') {\n          base64 = bin.data;\n        }\n      }\n    }\n  }\n\n  // 2) textê°€ ì•„ì§ ì—†ê³ , base64ë¥¼ ì°¾ì•˜ìœ¼ë©´ Bufferë¡œ ë””ì½”ë”©\n  if (!text && base64) {\n    const buff = Buffer.from(base64, 'base64');\n    text = buff.toString('utf8');\n  }\n\n  // 3) ì—¬ì „íˆ textê°€ ì—†ìœ¼ë©´ ì—ëŸ¬\n  if (!text) {\n    throw new Error(\n      'Txt â†’ Text: textë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. json.textë„ ì—†ê³  binaryì— base64 ë°ì´í„°ë„ ì—†ìŠµë‹ˆë‹¤.',\n    );\n  }\n\n  // 4) ìµœì¢… ê²°ê³¼ ë°˜í™˜ (json.text í•„ë“œì— ìˆœìˆ˜ í…ìŠ¤íŠ¸)\n  results.push({\n    json: {\n      ...item.json,\n      text,\n    },\n  });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        -32
      ],
      "id": "06927c53-e805-413c-af46-884660e1dc9b",
      "name": "Txt â†’ Text"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Index Trigger": {
      "main": [
        [
          {
            "node": "Load Azure Env",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chunk Text": {
      "main": [
        [
          {
            "node": "Attach Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "Prep Callback Success",
            "type": "main",
            "index": 0
          },
          {
            "node": "Azure OpenAI Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Search Doc": {
      "main": [
        [
          {
            "node": "Azure Search Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Azure Search Upsert": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Callback Success": {
      "main": [
        [
          {
            "node": "HTTP Callback Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "On Error": {
      "main": [
        [
          {
            "node": "Prep Callback Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Callback Failure": {
      "main": [
        [
          {
            "node": "HTTP Callback Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get blob": {
      "main": [
        [
          {
            "node": "Build DI Url",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Azure OpenAI Embedding": {
      "main": [
        [
          {
            "node": "Build Search Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Azure Env": {
      "main": [
        [
          {
            "node": "Get blob",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Metadata": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Txt Get blob",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract text (Azure DI - Code)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract text (Azure DI - Code)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract text (Azure DI - Code)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for DI": {
      "main": [
        [
          {
            "node": "Get DI Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get DI Result": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DI â†’ Text": {
      "main": [
        [
          {
            "node": "Chunk Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build DI Url": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare DI Result URL": {
      "main": [
        [
          {
            "node": "Wait for DI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract text (Azure DI - Code)": {
      "main": [
        [
          {
            "node": "Prepare DI Result URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "DI â†’ Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check DI Status & Retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check DI Status & Retry": {
      "main": [
        [
          {
            "node": "Wait for DI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Txt Get blob": {
      "main": [
        [
          {
            "node": "Txt â†’ Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Txt â†’ Text": {
      "main": [
        [
          {
            "node": "Chunk Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "58f0216e-7b0e-4a9d-a209-1c93a59ef033",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "061134d80b5d1260887925d3d8c3e524db2b0cf81d19a1c146eba918ad779534"
  },
  "id": "C7M8XObV5LoBKNzm",
  "tags": []
}